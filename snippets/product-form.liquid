{%- liquid
  assign th_st = settings
  assign show_compare = th_st.show_compare
  assign products_group = product.metafields.bls.product_grouped
  assign enable_catalog_mode = th_st.enable_catalog_mode
  assign show_wishlist = th_st.show_wishlist
  assign show_compare = th_st.show_compare
  assign current_variant = product.selected_or_first_available_variant
%}

{%- if product.metafields.custom.external_affiliate == blank -%}
  {%- if products_group == blank -%}
    <div
      {{ block.shopify_attributes }}
      id="product-form"
      class="mb-25"
    >
      {%- if enable_catalog_mode -%}
        <div class="product-form__buttons flex mb-10 flex-wrap-mb">
          <div
            class="bls__product-action-inner flex flex-1"
            style="--bls__product-icon-radius: var(--btn-border-radius);"
          >
            {%- if show_wishlist -%}
              <button
                type="button"
                name="add"
                role="button"
                aria-label="button"
                class="btn-reset bls__product-wishlist bls__product-wishlist-js bls__product-action-btn-js bls_tooltip border mr-10 mb-15 btn-radius"
                data-pro-add-wishlist="{{ 'products.product.wishlist' | t }}"
                data-pro-remove-wishlist="{{ 'products.product.browse_wishlist' | t }}"
                data-product-handle="{{ product.handle }}"
              >
                <span class="bls__product-icon min-height-48 m-width-48 box-shadow-none">
                  <svg
                    width="16"
                    height="15"
                    viewBox="0 0 16 15"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path d="M13.4219 2.875C13.7135 3.16667 13.9323 3.5 14.0781 3.875C14.224 4.23958 14.2969 4.61458 14.2969 5C14.2969 5.38542 14.224 5.76562 14.0781 6.14062C13.9323 6.50521 13.7135 6.83333 13.4219 7.125L8 12.5469L2.57812 7.125C2.28646 6.83333 2.06771 6.50521 1.92188 6.14062C1.77604 5.76562 1.70312 5.38542 1.70312 5C1.70312 4.61458 1.77604 4.23958 1.92188 3.875C2.06771 3.5 2.28646 3.16667 2.57812 2.875C2.86979 2.58333 3.19792 2.36458 3.5625 2.21875C3.9375 2.07292 4.31771 2 4.70312 2C5.08854 2 5.46354 2.07292 5.82812 2.21875C6.19271 2.36458 6.52604 2.58333 6.82812 2.875L7.53125 3.57812C7.65625 3.71354 7.8125 3.78125 8 3.78125C8.1875 3.78125 8.34375 3.71354 8.46875 3.57812L9.17188 2.875C9.47396 2.58333 9.80729 2.36458 10.1719 2.21875C10.5365 2.07292 10.9115 2 11.2969 2C11.6823 2 12.0573 2.07292 12.4219 2.21875C12.7969 2.36458 13.1302 2.58333 13.4219 2.875ZM14.3594 1.9375C13.9427 1.51042 13.4635 1.19271 12.9219 0.984375C12.3906 0.776042 11.849 0.671875 11.2969 0.671875C10.7448 0.671875 10.2031 0.776042 9.67188 0.984375C9.14062 1.19271 8.66146 1.51042 8.23438 1.9375L8 2.17188L7.76562 1.9375C7.33854 1.51042 6.85938 1.19271 6.32812 0.984375C5.79688 0.776042 5.25521 0.671875 4.70312 0.671875C4.15104 0.671875 3.60417 0.776042 3.0625 0.984375C2.53125 1.19271 2.05729 1.51042 1.64062 1.9375C1.21354 2.35417 0.890625 2.83333 0.671875 3.375C0.463542 3.90625 0.359375 4.44792 0.359375 5C0.359375 5.55208 0.463542 6.09896 0.671875 6.64062C0.890625 7.17188 1.21354 7.64583 1.64062 8.0625L7.53125 13.9531C7.65625 14.0885 7.8125 14.1562 8 14.1562C8.1875 14.1562 8.34375 14.0885 8.46875 13.9531L14.3594 8.0625C14.7865 7.64583 15.1042 7.17188 15.3125 6.64062C15.5312 6.09896 15.6406 5.55208 15.6406 5C15.6406 4.44792 15.5312 3.90625 15.3125 3.375C15.1042 2.84375 14.7865 2.36458 14.3594 1.9375Z" fill="#111111" />
                  </svg>
                </span>
                <span class="bls_tooltip-content">{{ 'products.product.wishlist' | t }}</span>
              </button>
            {%- endif -%}
            {%- if show_compare -%}
              <button
                type="button"
                name="add"
                role="button"
                aria-label="button"
                class="btn-reset bls__product-compare bls__product-compare-js bls__product-action-btn-js bls_tooltip border mb-15 btn-radius"
                data-pro-add-compare="{{ 'products.product.compare' | t }}"
                data-pro-remove-compare="{{ 'products.product.browse_compare' | t }}"
                data-product-handle="{{ product.handle }}"
              >
                <span class="bls__product-icon min-height-48 m-width-48 box-shadow-none">
                  <svg
                    width="16"
                    height="15"
                    viewBox="0 0 16 15"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path d="M8 1.40625L13.1719 4L8 6.59375L2.82812 4L8 1.40625ZM7.70312 0.078125L1.03125 3.40625C0.864583 3.48958 0.75 3.61979 0.6875 3.79688C0.635417 3.96354 0.651042 4.13021 0.734375 4.29688C0.765625 4.36979 0.807292 4.43229 0.859375 4.48438C0.911458 4.52604 0.96875 4.5625 1.03125 4.59375L7.70312 7.92188C7.79688 7.97396 7.89583 8 8 8C8.10417 8 8.20312 7.97396 8.29688 7.92188L14.9688 4.59375C15.1354 4.51042 15.2448 4.38542 15.2969 4.21875C15.3594 4.04167 15.349 3.86979 15.2656 3.70312C15.2344 3.63021 15.1927 3.57292 15.1406 3.53125C15.0885 3.47917 15.0312 3.4375 14.9688 3.40625L8.29688 0.0625C8.20312 0.0208333 8.10417 0 8 0C7.89583 0 7.79688 0.0208333 7.70312 0.0625V0.078125ZM1.03125 11.2656L7.70312 14.5938C7.79688 14.6458 7.89583 14.6667 8 14.6562C8.10417 14.6562 8.20312 14.6354 8.29688 14.5938L14.9688 11.2656C15.1354 11.1823 15.2448 11.0521 15.2969 10.875C15.3594 10.6979 15.349 10.5312 15.2656 10.375C15.1823 10.2083 15.0521 10.099 14.875 10.0469C14.6979 9.98438 14.5312 9.98958 14.375 10.0625L8 13.25L1.625 10.0781C1.46875 9.99479 1.30208 9.98438 1.125 10.0469C0.947917 10.099 0.817708 10.2083 0.734375 10.375C0.651042 10.5312 0.635417 10.6979 0.6875 10.875C0.75 11.0521 0.864583 11.1823 1.03125 11.2656ZM1.03125 7.92188L7.70312 11.2656C7.79688 11.3073 7.89583 11.3281 8 11.3281C8.10417 11.3281 8.20312 11.3073 8.29688 11.2656L14.9688 7.92188C15.1354 7.84896 15.2448 7.72396 15.2969 7.54688C15.3594 7.36979 15.349 7.19792 15.2656 7.03125C15.1823 6.86458 15.0521 6.75521 14.875 6.70312C14.6979 6.64062 14.5312 6.65104 14.375 6.73438L8 9.92188L1.625 6.73438C1.46875 6.65104 1.30208 6.64062 1.125 6.70312C0.947917 6.75521 0.817708 6.86458 0.734375 7.03125C0.651042 7.19792 0.635417 7.36979 0.6875 7.54688C0.75 7.72396 0.864583 7.85417 1.03125 7.9375V7.92188Z" fill="#111111" />
                  </svg>
                </span>
                <span class="bls_tooltip-content">{{ 'products.product.compare' | t }}</span>
              </button>
            {%- endif -%}
          </div>
        </div>
      {%- else -%}
        {%- liquid
          assign gift_card_recipient_feature_active = false
          if block.settings.show_gift_card_recipient and product.gift_card?
            assign gift_card_recipient_feature_active = true
          endif
        -%}
        <product-form
          class="product-form"
          data-hide-errors="{{ gift_card_recipient_feature_active }}"
        >
          <div
            class="product-form__error-message-wrapper"
            role="alert"
            hidden
          >
            <span class="product-form__error-message"></span>
          </div>
          {%- assign product_form_id = 'product-form-' | append: section.id -%}
          {%- form 'product',
            product,
            id: product_form_id,
            class: 'form',
            novalidate: 'novalidate',
            data-type: 'add-to-cart-form'
          -%}
            <input
              type="hidden"
              name="id"
              value="{{ product.selected_or_first_available_variant.id }}"
              disabled
            >
            {%- if gift_card_recipient_feature_active -%}
              {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
            {%- endif -%}
            <div class="product-form__buttons flex flex-wrap mb-10">
              <div class="bls__product-add-cart flex">
                <div
                  class="product-form__input product-form__quantity mb-15"
                  {{ block.shopify_attributes }}
                >
                  <label class="form__label visually-hidden" for="Quantity-{{ section.id }}">
                    {{ 'products.product.quantity.label' | t }}
                  </label>
                  <quantity-input class="quantity btn-radius border px-8 bg-grey flex align-items-center text-center mr-20 min-height-50">
                    <button
                      class="btn-reset flex justify-content-center align-items-center quantity__button no-js-hidden width-35"
                      name="minus"
                      title="Minus"
                      type="button"
                    >
                      <svg
                        width="11"
                        height="12"
                        viewBox="0 0 11 2"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path d="M11 0.5L11 1.5L-4.37114e-08 1.5L0 0.5L11 0.5Z" fill="#111111" />
                      </svg>
                    </button>
                    <input
                      class="quantity__input bg-unset border-none text-center width-50 appearance-none p-0-important product-detail__input"
                      type="number"
                      name="quantity"
                      id="Quantity-{{ section.id }}"
                      min="1"
                      value="1"
                      form="{{ product_form_id }}"
                    >
                    <button
                      class="btn-reset btn-add flex justify-content-center align-items-center quantity__button no-js-hidden width-35"
                      name="plus"
                      title="Plus"
                      type="button"
                    >
                      <svg
                        width="11"
                        height="12"
                        viewBox="0 0 11 12"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          fill-rule="evenodd"
                          clip-rule="evenodd"
                          d="M5 11.5H6L6 6.5H11V5.5H6L6 0.5H5L5 5.5H0V6.5H5L5 11.5Z"
                          fill="#111111" />
                      </svg>
                    </button>
                  </quantity-input>
                </div>
              </div>
              <div
                class="bls__product-action-inner flex flex-1"
                style="--bls__product-icon-radius: var(--btn-border-radius);"
              >
                <button
                  type="submit"
                  name="add"
                  class="product-form__submit relative flex-1 whitespace-nowrap min-height-48 mb-15 mr-10 animation {{ block.settings.button_animation }}"
                  {% if product.selected_or_first_available_variant.available == false %}
                    disabled
                  {% endif %}
                >
                  <span class="hidden-loading">
                    {%- if product.selected_or_first_available_variant.inventory_management != null -%}
                      {%- if product.selected_or_first_available_variant.available
                        and product.selected_or_first_available_variant.inventory_quantity < 1
                      -%}
                        {{ 'products.product.pre_order' | t }}
                      {%- elsif product.selected_or_first_available_variant.available -%}
                        {{ 'products.product.add_to_cart' | t }}
                      {%- else -%}
                        {{ 'products.product.sold_out' | t }}
                      {%- endif -%}
                    {%- else -%}
                      {{ 'products.product.add_to_cart' | t }}
                    {%- endif -%}
                  </span>
                  <span class="loader-icon"></span>
                </button>
                {%- if show_wishlist -%}
                  <button
                    type="button"
                    name="add"
                    role="button"
                    aria-label="button"
                    class="btn-reset bls__product-wishlist bls__product-wishlist-js bls__product-action-btn-js bls_tooltip border mr-10 mb-15 btn-radius"
                    data-pro-add-wishlist="{{ 'products.product.wishlist' | t }}"
                    data-pro-remove-wishlist="{{ 'products.product.browse_wishlist' | t }}"
                    data-product-handle="{{ product.handle }}"
                  >
                    <span class="bls__product-icon min-height-48 m-width-48 box-shadow-none">
                      <svg
                        width="16"
                        height="15"
                        viewBox="0 0 16 15"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path d="M13.4219 2.875C13.7135 3.16667 13.9323 3.5 14.0781 3.875C14.224 4.23958 14.2969 4.61458 14.2969 5C14.2969 5.38542 14.224 5.76562 14.0781 6.14062C13.9323 6.50521 13.7135 6.83333 13.4219 7.125L8 12.5469L2.57812 7.125C2.28646 6.83333 2.06771 6.50521 1.92188 6.14062C1.77604 5.76562 1.70312 5.38542 1.70312 5C1.70312 4.61458 1.77604 4.23958 1.92188 3.875C2.06771 3.5 2.28646 3.16667 2.57812 2.875C2.86979 2.58333 3.19792 2.36458 3.5625 2.21875C3.9375 2.07292 4.31771 2 4.70312 2C5.08854 2 5.46354 2.07292 5.82812 2.21875C6.19271 2.36458 6.52604 2.58333 6.82812 2.875L7.53125 3.57812C7.65625 3.71354 7.8125 3.78125 8 3.78125C8.1875 3.78125 8.34375 3.71354 8.46875 3.57812L9.17188 2.875C9.47396 2.58333 9.80729 2.36458 10.1719 2.21875C10.5365 2.07292 10.9115 2 11.2969 2C11.6823 2 12.0573 2.07292 12.4219 2.21875C12.7969 2.36458 13.1302 2.58333 13.4219 2.875ZM14.3594 1.9375C13.9427 1.51042 13.4635 1.19271 12.9219 0.984375C12.3906 0.776042 11.849 0.671875 11.2969 0.671875C10.7448 0.671875 10.2031 0.776042 9.67188 0.984375C9.14062 1.19271 8.66146 1.51042 8.23438 1.9375L8 2.17188L7.76562 1.9375C7.33854 1.51042 6.85938 1.19271 6.32812 0.984375C5.79688 0.776042 5.25521 0.671875 4.70312 0.671875C4.15104 0.671875 3.60417 0.776042 3.0625 0.984375C2.53125 1.19271 2.05729 1.51042 1.64062 1.9375C1.21354 2.35417 0.890625 2.83333 0.671875 3.375C0.463542 3.90625 0.359375 4.44792 0.359375 5C0.359375 5.55208 0.463542 6.09896 0.671875 6.64062C0.890625 7.17188 1.21354 7.64583 1.64062 8.0625L7.53125 13.9531C7.65625 14.0885 7.8125 14.1562 8 14.1562C8.1875 14.1562 8.34375 14.0885 8.46875 13.9531L14.3594 8.0625C14.7865 7.64583 15.1042 7.17188 15.3125 6.64062C15.5312 6.09896 15.6406 5.55208 15.6406 5C15.6406 4.44792 15.5312 3.90625 15.3125 3.375C15.1042 2.84375 14.7865 2.36458 14.3594 1.9375Z" fill="#111111" />
                      </svg>
                    </span>
                    <span class="bls_tooltip-content">{{ 'products.product.wishlist' | t }}</span>
                  </button>
                {%- endif -%}
                {%- if show_compare -%}
                  <button
                    type="button"
                    name="add"
                    role="button"
                    aria-label="button"
                    class="btn-reset bls__product-compare bls__product-compare-js bls__product-action-btn-js bls_tooltip border mb-15 btn-radius"
                    data-pro-add-compare="{{ 'products.product.compare' | t }}"
                    data-pro-remove-compare="{{ 'products.product.browse_compare' | t }}"
                    data-product-handle="{{ product.handle }}"
                  >
                    <span class="bls__product-icon min-height-48 m-width-48 box-shadow-none">
                      <svg
                        width="16"
                        height="15"
                        viewBox="0 0 16 15"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path d="M8 1.40625L13.1719 4L8 6.59375L2.82812 4L8 1.40625ZM7.70312 0.078125L1.03125 3.40625C0.864583 3.48958 0.75 3.61979 0.6875 3.79688C0.635417 3.96354 0.651042 4.13021 0.734375 4.29688C0.765625 4.36979 0.807292 4.43229 0.859375 4.48438C0.911458 4.52604 0.96875 4.5625 1.03125 4.59375L7.70312 7.92188C7.79688 7.97396 7.89583 8 8 8C8.10417 8 8.20312 7.97396 8.29688 7.92188L14.9688 4.59375C15.1354 4.51042 15.2448 4.38542 15.2969 4.21875C15.3594 4.04167 15.349 3.86979 15.2656 3.70312C15.2344 3.63021 15.1927 3.57292 15.1406 3.53125C15.0885 3.47917 15.0312 3.4375 14.9688 3.40625L8.29688 0.0625C8.20312 0.0208333 8.10417 0 8 0C7.89583 0 7.79688 0.0208333 7.70312 0.0625V0.078125ZM1.03125 11.2656L7.70312 14.5938C7.79688 14.6458 7.89583 14.6667 8 14.6562C8.10417 14.6562 8.20312 14.6354 8.29688 14.5938L14.9688 11.2656C15.1354 11.1823 15.2448 11.0521 15.2969 10.875C15.3594 10.6979 15.349 10.5312 15.2656 10.375C15.1823 10.2083 15.0521 10.099 14.875 10.0469C14.6979 9.98438 14.5312 9.98958 14.375 10.0625L8 13.25L1.625 10.0781C1.46875 9.99479 1.30208 9.98438 1.125 10.0469C0.947917 10.099 0.817708 10.2083 0.734375 10.375C0.651042 10.5312 0.635417 10.6979 0.6875 10.875C0.75 11.0521 0.864583 11.1823 1.03125 11.2656ZM1.03125 7.92188L7.70312 11.2656C7.79688 11.3073 7.89583 11.3281 8 11.3281C8.10417 11.3281 8.20312 11.3073 8.29688 11.2656L14.9688 7.92188C15.1354 7.84896 15.2448 7.72396 15.2969 7.54688C15.3594 7.36979 15.349 7.19792 15.2656 7.03125C15.1823 6.86458 15.0521 6.75521 14.875 6.70312C14.6979 6.64062 14.5312 6.65104 14.375 6.73438L8 9.92188L1.625 6.73438C1.46875 6.65104 1.30208 6.64062 1.125 6.70312C0.947917 6.75521 0.817708 6.86458 0.734375 7.03125C0.651042 7.19792 0.635417 7.36979 0.6875 7.54688C0.75 7.72396 0.864583 7.85417 1.03125 7.9375V7.92188Z" fill="#111111" />
                      </svg>
                    </span>
                    <span class="bls_tooltip-content">{{ 'products.product.compare' | t }}</span>
                  </button>
                {%- endif -%}
              </div>
            </div>
            {% if product.selected_or_first_available_variant.available %}
              <div class="bls__product-dynamic-checkout">
                {%- if block.settings.show_buy_now -%}
                  {%- if th_st.enable_product_terms_conditions -%}
                    <div class="bls__terms-conditions flex mb-25">
                      <div class="checkbox-group relative">
                        <input
                          class="input m-0 opacity-0 absolute inset-0 pointer inset-0"
                          type="checkbox"
                          name="conditions"
                          id="product_conditions_form"
                        >
                        <span class="checkmark"></span>
                      </div>
                      <label class="label form-label pointer" for="product_conditions_form">
                        {{ settings.content_terms_conditions }}
                      </label>
                    </div>
                  {%- endif -%}
                  <div class="bls__payment-button{% if settings.enable_product_terms_conditions %} disabled{% endif %}">
                    {{ form | payment_button }}
                  </div>
                {%- endif -%}
              </div>
            {% endif %}
            {%- if th_st.use_stock_notify -%}
              <div
                class="bls__product-action-inner mt-15"
                style="--bls__product-icon-radius: var(--btn-border-radius);"
              >
                <a
                  href="#stock-notify"
                  class="btn text-center product-notify-stock relative w-full whitespace-nowrap min-height-48 mb-15 mr-10 animation flash-move "
                  data-product-variant="{{ current_variant.id }}"
                  style="{% if product.selected_or_first_available_variant.available == false %}display:block{% else %}display:none{% endif %}"
                >
                  <span class="">{{ 'products.product.stock_notify_label' | t }}</span>
                </a>
              </div>
            {%- endif -%}
          {%- endform -%}
        </product-form>
      {%- endif -%}
    </div>
  {%- endif -%}
{%- else -%}
  <a
    href="{{ product.metafields.custom.external_affiliate.value.external_link }}"
    rel="nofollow"
    target="_blank"
    class="btn product-form__submit relative text-center w-full whitespace-nowrap min-height-48 mb-15 mr-10 animation flash-move"
  >
    {{- product.metafields.custom.external_affiliate.value.button_text -}}
  </a>
{%- endif -%}
